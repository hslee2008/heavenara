<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>지도 생성하기</title>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6072e8a0344039acacc746c3c35906fb"
    ></script>
    <script
      type="text/javascript"
      src="https://t1.daumcdn.net/mapjsapi/js/libs/services/1.0.2/services.js"
    ></script>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6072e8a0344039acacc746c3c35906fb&libraries=services"
    ></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b620fe5e2bde65b6144d6949145b0ff8&libraries=services,clusterer,drawing"></script>
    <script
      type="text/javascript"
      src="//t1.daumcdn.net/mapjsapi/js/libs/clusterer/1.0.9/clusterer.js"
    ></script>

    <script src="html.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        width: 100%;
        height: 100vh;
      }

    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      (async function () {
        let lat, lon, map;

        function init(position) {
          lat = position.coords.latitude;
          lon = position.coords.longitude;

          var mapContainer = document.getElementById("map");
          var mapOption = {
            center: new kakao.maps.LatLng(lat, lon),
            level: screen.width < 1000 ? 12 : 13,
          };

          map = new kakao.maps.Map(mapContainer, mapOption);

          map.addControl(
            new kakao.maps.MapTypeControl(),
            kakao.maps.ControlPosition.TOPRIGHT
          );
          map.addControl(
            new kakao.maps.ZoomControl(),
            kakao.maps.ControlPosition.RIGHT
          );

          /* Where you are */
          let marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lon),
          });

          marker.setMap(map);
        }

        if (navigator.geolocation) {
          await navigator.geolocation.getCurrentPosition(init);
        }

        /* EarthQuake */
        var imageSrc = "img/earthquake.png",
          imageSize = new kakao.maps.Size(64, 69),
          imageOption = { offset: new kakao.maps.Point(27, 69) };

        var markerImage = new kakao.maps.MarkerImage(
          imageSrc,
          imageSize,
          imageOption
        );

        fetch("https://heavenara.onrender.com/scrape-earthquake")
          .then((res) => res.json())
          .then((res) => {
            console.log(res);

            for (let i = 0; i < res.length; i++) {
              const longitude = parseFloat(res[i].info.longitude);
              const latitude = parseFloat(res[i].info.latitude);
              const position = new kakao.maps.LatLng(latitude, longitude);

              let marker = new kakao.maps.Marker({
                position,
                image: markerImage,
              });

              var customOverlay = new kakao.maps.CustomOverlay({
                position,
                content: returnEQ(res[i]),
              });

              customOverlay.setMap(map);

              marker.setMap(map);
            }
          });
        /* EarthQuake */

        /* Strong Winds */
        imageSrc = "img/gale.png";

        const markers = []

        function placesSearchCB(data, status, pagination) {
          for (var i = 0; i < data.length; i++) {
            displayMarker(data[i]);
          }
        }

        function displayMarker(place) {
          markers.push(new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x),
          }))
        }

        var clusterer = new kakao.maps.MarkerClusterer({
          map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
          averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
          minLevel: 5, // 클러스터 할 최소 지도 레벨,
          markers: markers,
        });

        fetch("https://heavenara.onrender.com/scrape-strongwind")
          .then((res) => res.json())
          .then((res) => {
            for (let i = 0; i < res.length; i++) {
              const area = res[i].area;

              var ps = new kakao.maps.services.Places();

              ps.keywordSearch(area, placesSearchCB);
            }
          });

        /* Heat Wave */
        /*fetch("https://heavenara.onrender.com/scrape-heatwave")
        .then((res) => res.json())
        .then((res) => {
          console.log(res);
        });
      */
      })();
    </script>
  </body>
</html>
